<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:int-amqp="http://www.springframework.org/schema/integration/amqp"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rabbit="http://www.springframework.org/schema/rabbit"
       xsi:schemaLocation="http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/amqp
  http://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd
  http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit.xsd">

  <int:channel id="ocErrorChannel" />

  <int:exception-type-router input-channel="ocErrorChannel" default-output-channel="invalidMessageChannel">
    <int:mapping exception-type="com.mysql.jdbc.exceptions.jdbc4.CommunicationsException" channel="ocErrorRequeueChannel" />
    <int:mapping exception-type="java.sql.SQLRecoverableException" channel="ocErrorRequeueChannel" />
    <int:mapping exception-type="java.net.ConnectException" channel="ocErrorRequeueChannel" />
    <int:mapping exception-type="java.net.SocketException" channel="ocErrorRequeueChannel" />
    <int:mapping exception-type="java.net.PortUnreachableException" channel="ocErrorRequeueChannel" />
    <int:mapping exception-type="java.net.NoRouteToHostException" channel="ocErrorRequeueChannel" />
    <int:mapping exception-type="java.net.SocketTimeoutException" channel="ocErrorRequeueChannel" />
  </int:exception-type-router>

  <int:channel id="ocErrorRequeueChannel" />

  <int:service-activator input-channel="ocErrorRequeueChannel" output-channel="ocRequeueChannel"
    ref="messageLogger" method="logAndUnwrap" />

  <int:channel id="ocRequeueChannel" />

  <int:chain input-channel="ocRequeueChannel" output-channel="ocRequeueOriginalChannel">
    <int:transformer expression="headers.storedMessageId" />
    <int:claim-check-out message-store="simpleMessageStore" remove-message="true" />
  </int:chain>

  <int:channel id="ocRequeueOriginalChannel" />

  <int-amqp:outbound-channel-adapter channel="ocRequeueOriginalChannel" amqp-template="ocRequeueRabbitTemplate"
    exchange-name="${exc.feed.sender.dead.letter}" mapped-request-headers="oc_*,sdc_*,stamp_uuid" routing-key-expression="headers.amqp_receivedRoutingKey" />

  <rabbit:template id="ocRequeueRabbitTemplate" connection-factory="ocConsumerConnectionFactory" />

</beans>
